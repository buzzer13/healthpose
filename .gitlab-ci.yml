image: docker:latest

services:
- docker:dind

stages:
- prepare
- build

before_script:
- docker info
- docker login --username gitlab-ci-token --password "$CI_JOB_TOKEN" "$CI_REGISTRY"

variables:
  APP_CURRENT_IMAGE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"
  APP_LATEST_IMAGE: "$CI_REGISTRY_IMAGE:latest"
  PLATFORMS: "linux/arm/v7,linux/arm64/v8,linux/amd64"

buildx-app:
  stage: build
  script:
  - docker pull "$APP_LATEST_IMAGE" || true
  - docker buildx create --use
  - docker buildx build --push --platform "$PLATFORMS" --file "Containerfile" --build-arg "REF=$CI_COMMIT_REF_SLUG" --build-arg "SHA=$CI_COMMIT_SHORT_SHA" --tag "$APP_CURRENT_IMAGE" --tag "$APP_LATEST_IMAGE" .
  rules:
  - if: '$CI_COMMIT_TAG =~ /^v/'
    when: on_success
    exists:
    - Containerfile
